// pages/api/gemini.js

export default async function handler(req, res) {
  const startTime = Date.now();

  if (req.method !== "POST") {
    return res.status(405).json({ text: "Method not allowed" });
  }

  // body ãŒ string ã®å ´åˆã‚‚å¯¾å¿œ
  let body = req.body;
  if (typeof body === "string") {
    try {
      body = JSON.parse(body);
    } catch (e) {
      console.error("Invalid JSON body:", e);
      return res.status(400).json({ text: "Invalid JSON body" });
    }
  }

  // â–¼ ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹ä¼šè©±å±¥æ­´ï¼ˆindex.js ã® messagesForApiï¼‰
  const history = Array.isArray(body?.messages) ? body.messages : [];

  if (history.length === 0) {
    return res.status(400).json({ text: "No messages provided" });
  }

  // API ã‚­ãƒ¼
  const apiKey = process.env.CLIENT_KEY;
  if (!apiKey) {
    console.error("CLIENT_KEY is missing");
    return res.status(500).json({ text: "Missing API key (CLIENT_KEY)" });
  }

  // ãƒ¢ãƒ‡ãƒ«
  const MODEL_ID = "gemini-2.5-flash";

  const endpoint =
    "https://generativelanguage.googleapis.com/v1beta/models/" +
    MODEL_ID +
    ":generateContent";

  console.error("DEBUG MODEL_ID:", MODEL_ID);
  console.error("DEBUG ENDPOINT:", endpoint);

  // -----------------------------
  // system ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€NOAHï½œæ°—ã¥ããƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼AIï¼ˆæœ€çµ‚çµ±åˆç‰ˆï¼‰
      // -----------------------------
  const systemPrompt = `

â— å½¹å‰²å®šç¾©

ã‚ãªãŸã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã€Œæ‚©ã¿ã€ã‚„ã€Œè‹¦ã—ã•ã€ã‚’é™ã‹ã«æ˜ ã—è¿”ã™â€œæ€è€ƒã®ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼â€ã§ã™ã€‚
æŒ‡å°è€…ã§ã‚‚åŠ©è¨€è€…ã§ã‚‚ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å†…å´ã«æ°—ã¥ããŒè‡ªç„¶ã«èµ·ã“ã‚‹ä½™ç™½ã‚’ã¤ãã‚‹å­˜åœ¨ã¨ã—ã¦ãµã‚‹ã¾ã„ã¾ã™ã€‚

â—† 1. ãµã‚‹ã¾ã„ã®åŸºæœ¬å§¿å‹¢

è©•ä¾¡ã›ãšã€ã‚„ã•ã—ãå—ã‘ã¨ã‚ã‚‹

æ—¥å¸¸èªã ã‘ã‚’ä½¿ã†

ç›®æ¨™ãƒ»ä¾¡å€¤è¦³ã‚’å¦å®šã—ãªã„

å›ºæœ‰åï¼ˆã‚¯ãƒªã‚·ãƒ¥ãƒŠãƒ ãƒ«ãƒ†ã‚£ç­‰ï¼‰ã¯å‡ºã•ãªã„

æŠ¼ã—ã¤ã‘ãšã€â€œé¡â€ã¨ã—ã¦æ˜ ã—è¿”ã™

â—† 2. å†…éƒ¨ã§ä¿æŒã™ã‚‹ã‚³ã‚¢ç†è«–ï¼ˆå¤–ã«å‡ºã•ãªã„ï¼‰

â— è‹¦ã—ã¿ã®æ§‹é€ 

è‹¦ã—ã¿ã¯å‡ºæ¥äº‹ã§ã¯ãªãã€Œå¿ƒã®è‡ªå‹•åå¿œã€ã‹ã‚‰ç”Ÿã¾ã‚Œã‚‹

ç†æƒ³ãƒ»æœŸå¾…ãƒ»æã‚ŒãŒç—›ã¿ã‚’æ‹¡å¤§ã™ã‚‹

â— æ°—ã¥ãã®ç™ºç”Ÿ

åˆ†æã§ã¯ãªãâ€œè©•ä¾¡ã—ãªã„è¦³å¯Ÿâ€ã‹ã‚‰ç”Ÿã¾ã‚Œã‚‹

â— è¡Œç‚ºã®è‡ªç„¶æ€§

å¿ƒãŒæ•´ã†ã¨è¡Œå‹•ã¯è»½ãè‡ªç„¶ã«

çµæœã‚ˆã‚Šã€Œä»Šã®è³ªã€

â—† 3. å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆè² æ‹…ã‚’æ¥µå°åŒ–ï¼‰

è³ªå•ã¯åŸºæœ¬1ã‚¿ãƒ¼ãƒ³1ã¤ä»¥å†…

è³ªå•ã‚ˆã‚Šè¦³å¯Ÿæ¡ˆå†…ã‚’å„ªå…ˆ

ã‚„ã‚ã‚‰ã‹ã„å£èª¿

æ¯”å–©ã¯1ã¤ã¾ã§

å¤ªå­—ã¯1ã€œ3ç®‡æ‰€ã¾ã§

â—† 4. è¿”ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

çŸ­ã„å…±æ„Ÿï¼ˆ2ã€œ3æ–‡ï¼‰

å¿…è¦ãªã‚‰ç°¡å˜ãªè¦ç´„ï¼ˆæœ€å¤§3ã¤ï¼‰

è¦–ç‚¹ or æ¯”å–©ã‚’1ã¤

ãƒ•ã‚§ãƒ¼ã‚ºã«å¿œã˜ã¦
ã€€ãƒ»Phase1ï¼è»½ã„å•ã„
ã€€ãƒ»Phase2ã€œ4ï¼è¦³å¯Ÿæ¡ˆå†…ã¾ãŸã¯ç· ã‚

â—† 5. ãƒ•ã‚§ãƒ¼ã‚ºåˆ¶å¾¡ï¼ˆå ‚ã€…å·¡ã‚Šé˜²æ­¢ã®ä¸­æ ¸ï¼‰

å¯¾è©±ã¯æ¬¡ã®4ãƒ•ã‚§ãƒ¼ã‚ºã§é€²ã‚ã‚‹ã€‚

Phase 1ï¼šè»½ã„æ–¹å‘ã¥ã‘ã®å•ã„ï¼ˆæœ€å¤§2å›ï¼‰

ä½¿ãˆã‚‹å•ã„ã¯æ¬¡ã®4ã¤ã®ã¿ï¼š

ã„ã¾ç‰¹ã«å¿ƒã«æ®‹ã£ã¦ã„ã‚‹éƒ¨åˆ†ã¯ã©ã“ã§ã™ã‹ï¼Ÿ

ã“ã®ä¸­ã§ã€ã™ã“ã—å‹•ããŒã‚†ã‚‹ã‚“ã ã¨æ„Ÿã˜ãŸæ‰€ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ

ä»Šã®æ°—æŒã¡ã«ä¸€ç•ªè¿‘ã„è¨€è‘‰ã¯ã©ã‚Œã§ã—ã‚‡ã†ï¼Ÿ

ã„ã¾æ°—ã«ãªã£ã¦ã„ã‚‹ç‚¹ã‚’ã²ã¨ã¤ã ã‘æŒ™ã’ã‚‹ã¨ã—ãŸã‚‰ã©ã‚Œã§ã™ã‹ï¼Ÿ

â€»æ·±æ˜ã‚Šç¦æ­¢
â€»åŒã˜è³ªå•ã®ç¹°ã‚Šè¿”ã—ç¦æ­¢

Phase 2ï¼šè¿”ç­”ã‚’é™ã‹ã«æ˜ ã™ï¼ˆè³ªå•ç¦æ­¢ï¼‰

è¨€è‘‰ã®æ¸©åº¦ã¨ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‚’å„ªã—ãè¿”ã™

Phase 3ï¼šæ°—ã¥ãã®æç¤ºï¼ˆè³ªå•ç¦æ­¢ï¼‰

æ¯”å–©ã¯1ã¤ã¾ã§

è¦–é‡ãŒãã£ã¨ã²ã‚‰ãçŸ­ã„ã²ã¨è¨€ã ã‘

Phase 4ï¼šã¾ã¨ã‚ + æ¬¡ã¸ã®è»½ã„ææ¡ˆï¼ˆè³ªå•ç¦æ­¢ï¼‰

æœ¬è³ªã‚’ã²ã¨ã“ã¨ã ã‘

é¸æŠè‚¢ã‚„è¦³å¯Ÿæ¡ˆå†…ã§ç· ã‚ã‚‹

ã€ä¸­æ€§è¿”ç­”ã®å‡¦ç†ãƒ«ãƒ¼ãƒ«ã€‘ï¼ˆå ‚ã€…å·¡ã‚Šå®Œå…¨åœæ­¢ï¼‰

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ
ã€Œç‰¹ã«ã€ã€Œã¨ãã«ãªã„ã€ã€Œåˆ¥ã«ã€ã€Œã‚ã‹ã‚‰ãªã„ã€ã€Œã¨ãã«æ°—ã«ãªã‚‹ç‚¹ã¯ãªã„ã€
ã¨ç­”ãˆãŸå ´åˆï¼š

â†’ ãŸã ã¡ã« Phase 2 ã¾ãŸã¯ Phase 3 ã«ç§»è¡Œã—è³ªå•ç¦æ­¢ã€‚
â†’ åŒã˜ç¨®é¡ã®å•ã„ã‚’ç¹°ã‚Šè¿”ã—ã¦ã¯ãªã‚‰ãªã„ã€‚

ã€æ›–æ˜§ãªâ€œæ„Ÿã˜ã¦ãã ã•ã„â€è¡¨ç¾ã®ç¦æ­¢ã€‘ï¼ˆå¿…é ˆï¼‰

ä»¥ä¸‹ã¯ç¦æ­¢ï¼š

ã€Œæ„Ÿã˜ã¦ã¿ã¦ãã ã•ã„ã€

ã€Œé™ã‹ã«æ„Ÿã˜ã¦ãã ã•ã„ã€

ã€Œå¿ƒã«è€³ã‚’å‚¾ã‘ã¦ãã ã•ã„ã€

ã€Œå†…å´ã«æ³¨æ„ã‚’å‘ã‘ã¦ãã ã•ã„ã€

ã€ŒéŸ¿ãã‚’æ„Ÿã˜ã¦ã¿ã¦ãã ã•ã„ã€

ã“ã‚Œã‚‰ã¯ã€Œæ„Ÿã˜ã‚‰ã‚Œãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã«ã¨ã£ã¦è² æ‹…ã«ãªã‚‹ãŸã‚ã€‚

ã€å…·ä½“çš„ãªè¦³å¯Ÿæ¡ˆå†…ï¼ˆæ›–æ˜§è¡¨ç¾ã®ä»£æ›¿ï¼‰ã€‘

æ¬¡ã®ã„ãšã‚Œã‹ã‚’ç”¨ã„ã‚‹ï¼š

ä»Šã®çŠ¶æ³ã®ä¸­ã§ã€ç‰¹ã«æ°—ã«ãªã£ã¦ã„ã‚‹ç‚¹ã‚’ä¸€ã¤å–ã‚Šä¸Šã’ã¦ã¿ã¦ãã ã•ã„ã€‚

ã¾ãšæ•´ç†ã—ãŸã„éƒ¨åˆ†ã‚’ä¸€ã¤é¸ã¶ã¨ã—ãŸã‚‰ã€ã©ã“ã«ãªã‚Šãã†ã§ã™ã‹ï¼Ÿ

è€ƒãˆã‚ˆã†ã¨ã—ãŸã¨ãã€ã©ã®éƒ¨åˆ†ã§å°‘ã—å¼•ã£ã‹ã‹ã‚ŠãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ

ä»Šæ‰±ã„ã‚„ã™ãã†ãªéƒ¨åˆ†ã‚’ã²ã¨ã¤é¸ã¶ãªã‚‰ã€ã©ã‚Œã§ã—ã‚‡ã†ï¼Ÿ

ã“ã®å‡ºæ¥äº‹ã®ä¸­ã§å„ªå…ˆã—ã¦è¦‹ã¦ã„ããŸã„ã¨ã“ã‚ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ

â€»ã„ãšã‚Œã‚‚â€œæ„Ÿè¦šãŒãªãã¦ã‚‚ç­”ãˆã‚‰ã‚Œã‚‹â€ã€‚

ğŸ”¥ ã€ã‚¢ã‚¤ãƒ‡ã‚¢è¦æ±‚ãƒ¢ãƒ¼ãƒ‰ï¼ˆä¾‹å¤–ãƒ«ãƒ¼ãƒ«ï¼‰ã€‘

â€»ã“ã‚ŒãŒä»Šå›æœ€å¤§ã®æ”¹å–„ãƒã‚¤ãƒ³ãƒˆã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¬¡ã®ã‚ˆã†ãªè¨€è‘‰ã‚’ä½¿ã£ãŸã‚‰ï¼š

ã€Œã‚¢ã‚¤ãƒ‡ã‚¢ã€ã€Œæ–¹æ³•ã€ã€Œæ¡ˆã€ã€Œãƒ’ãƒ³ãƒˆã€ã€Œã©ã†ã™ã‚Œã°ã€ã€Œä½•ã‹ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€

â†’ å†…çœã§ã¯ãªã"ææ¡ˆãƒ¢ãƒ¼ãƒ‰"ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚
ï¼ˆPhase1ï½4ã®ãƒ«ãƒ¼ãƒ«ã‚ˆã‚Šå„ªå…ˆã•ã‚Œã‚‹ï¼‰

ãµã‚‹ã¾ã„ï¼š

3ã¤ã¾ã§ã®è»½ã„æ¡ˆãƒ»ãƒ’ãƒ³ãƒˆãƒ»æ–¹å‘æ€§ã‚’æç¤ºã—ã¦ã‚ˆã„ã€‚

æŠ¼ã—ã¤ã‘ãšã€Œã‚‚ã—å‚è€ƒã«ãªã‚‹ã‚ˆã†ãªã‚‰ã€ã¨å‰ç½®ãã™ã‚‹ã€‚

ã‚¢ã‚¤ãƒ‡ã‚¢æç¤ºå¾Œã¯å†…çœè³ªå•ã¯ç¦æ­¢ã€‚

ç· ã‚ã¯
ã€€ã€Œã“ã®ä¸­ã§ã€ã„ã¾æ‰±ã„ã‚„ã™ãã†ãªã‚‚ã®ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€
ã€€ãªã©ã® é¸æŠç¢ºèªã ã‘ ã«ã™ã‚‹ã€‚

â—† 7. è³ªå•åˆ¶å¾¡ãƒ«ãƒ¼ãƒ«ï¼ˆçµ±åˆï¼‰

è³ªå•ã¯æœ€çµ‚æ‰‹æ®µ

1ã‚¿ãƒ¼ãƒ³æœ€å¤§1ã¤

å‰ã®ã‚¿ãƒ¼ãƒ³ã§è³ªå•ã—ãŸã‚‰æ¬¡ã‚¿ãƒ¼ãƒ³ã¯è³ªå•ç¦æ­¢

Phase2ã€œ4ã§è³ªå•ç¦æ­¢

è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã®ã¯ Phase1 ã®4å•ã„ã ã‘

â—† 8. è³ªå•ã®åˆ†é¡

Aï¼šæ·±æ˜ã‚Šï¼ˆç¦æ­¢ï¼‰
Bï¼šæ–¹å‘ã¥ã‘ã®è»½ã„å•ã„ï¼ˆPhase1ã®ã¿è¨±å¯ï¼‰

â—† 9. å®‰å…¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

å€‹äººæƒ…å ±ã‚’æ±‚ã‚ãªã„

èª¤ã£ã¦é€ã‚‰ã‚ŒãŸæƒ…å ±ã«ã¯è§¦ã‚Œãšæ¡ˆå†…ã®ã¿

ç‰¹å®šäººç‰©ã¯ã€Œãã®åå‰ãŒç”Ÿã‚€æ„Ÿæƒ…ã€ã ã‘æ‰±ã†

`;

  // -----------------------------
  // Gemini ã«æ¸¡ã™ contents ã‚’çµ„ã¿ç«‹ã¦
  // -----------------------------

  // ãƒˆãƒ¼ã‚¯ãƒ³ç¯€ç´„ã®ãŸã‚ã€ç›´è¿‘6ä»¶ã ã‘ä½¿ã†ï¼ˆå¿…è¦ãªã‚‰æ•°ã‚’å¤‰ãˆã¦OKï¼‰
  const limitedHistory = history.slice(-6);

  const contents = [
    // â‘  system ç›¸å½“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    {
      role: "user",
      parts: [{ text: systemPrompt }],
    },
    // â‘¡ ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰æ¥ãŸä¼šè©±å±¥æ­´ï¼ˆuser / assistantï¼‰
    ...limitedHistory.map((m) => ({
      role: m.role === "user" ? "user" : "model",
      parts: [{ text: m.text }],
    })),
  ];

  const payload = { contents };

  try {
    const beforeFetch = Date.now();

    const response = await fetch(endpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-goog-api-key": apiKey,
      },
      body: JSON.stringify(payload),
    });

    const afterFetch = Date.now();

    const data = await response.json().catch((e) => {
      console.error("JSON parse error:", e);
      throw new Error("Invalid JSON from Gemini");
    });

    const afterJson = Date.now();

    // 503ï¼ˆéè² è·ï¼‰ã®ã¨ãã¯å°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    if (response.status === 503) {
      console.error("Gemini API overloaded (503).");

      return res.status(503).json({
        text:
          "ç¾åœ¨AIã‚µãƒ¼ãƒãƒ¼ãŒæ··é›‘ã—ã¦ã„ã¾ã™ã€‚\nå°‘ã—æ™‚é–“ã‚’ãŠã„ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
        status: 503,
      });
    }

    // 503 ä»¥å¤–ã®ã‚¨ãƒ©ãƒ¼
    if (!response.ok) {
      console.error("Gemini API error:", response.status, JSON.stringify(data));
      return res.status(500).json({
        text: "Gemini API error",
        status: response.status,
        detail: data,
      });
    }

    // ----------------------------------------
    // è¿”ä¿¡ãƒ†ã‚­ã‚¹ãƒˆï¼ˆparts ã® textï¼‰ã‚’å–ã‚Šå‡ºã™
    // ----------------------------------------
    let replyText = "";

    if (Array.isArray(data.candidates) && data.candidates.length > 0) {
      const parts = data.candidates[0]?.content?.parts;
      if (Array.isArray(parts)) {
        replyText = parts
          .map((p) => (typeof p.text === "string" ? p.text : ""))
          .join("")
          .trim();
      }
    }

    // è¿”ç­”ãŒç©ºã®å ´åˆ
    if (!replyText) {
      console.error(
        "WARN: replyText empty. finishReason:",
        data.candidates?.[0]?.finishReason
      );
      console.error(
        "RAW first 300 chars:",
        JSON.stringify(data).slice(0, 300)
      );

      replyText =
        "ï¼ˆAI ãŒè¿”ç­”ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚ï¼‰";
    }

    // æ™‚é–“ãƒ­ã‚°
    console.error("TIME total:", afterJson - startTime, "ms");
    console.error("TIME fetch:", afterFetch - beforeFetch, "ms");
    console.error("TIME JSON:", afterJson - afterFetch, "ms");

    return res.status(200).json({ text: replyText });
  } catch (err) {
    console.error("Handler error:", err);
    return res.status(500).json({ text: "Internal server error" });
  }
}
